rm(list = ls())

library(dlnm)
library(splines)
library(MASS)
library(tsModel)
library(dplyr)
library(mvmeta)
library(mixmeta)
library(data.table)
library(pls)
library(lubridate)

load("D:/Projection/sample/dlist.RData")
mp = fread("D:/Projection/sample/mp.csv")

sgg = names(dlist)
age_group = c('age_under74', 'age_over75')

coef = matrix(NA, 50, 4)
vcov = lapply(1:50, function(x) matrix(NA, 4,4))
pb <- txtProgressBar(min = 0, max = length(sgg), style = 3)  # 스타일 3: [===    ]
for(i in 1:25){
  setTxtProgressBar(pb, i)
  dat = dlist[[i]]
  argvar = list(fun = "ns",
                 knots = quantile(dat$tmean, c(0.1, 0.75, 0.9), na.rm = TRUE),
                 Bound = range(dat$tmean, na.rm = TRUE))
  arglag = list(fun = "ns", knots = logknots(21, nk = 3))
  cb = crossbasis(dat$tmean, argvar, arglag, lag = 21)
  
  m = glm(dth_u74 ~ cb + dow + ns(date, df = 7*length(unique(dat$year))),data = dat, family = quasipoisson)
  red = crossreduce(cb, m, cen = 10)
  coef[i,] = coef(red)
  vcov[[i]] = vcov(red)
  
  m = glm(dth_o75 ~ cb + dow + ns(date, df = 7*length(unique(dat$year))),data = dat, family = quasipoisson)
  red <- crossreduce(cb, m, cen = 10)
  coef[i+25,] = coef(red)
  vcov[[i+25]] = vcov(red)
  rm(dat, argvar, arglag, m, red)
}

mp = rbind(mp,mp)
mp$age = c(rep(0,25),rep(1,25))
mx = mixmeta(coef~.,dat=mp,vcov,random=~1|sgg,na.action=na.exclude)
blup = blup(mx,vcov=T)
blup1 = blup[1:25]
blup2 = blup[26:50]
rm(mp, mx, blup)
save(blup1, blup2, file = "D:/Projection/sample/2nd_stage.RData")

mmt = matrix(NA,25,2,dimnames=list(sgg,age_group))
for(i in 1:25){
  setTxtProgressBar(pb, i)
  dat <- dlist[[i]]
  argvar <- list(fun = "ns",
                 knots = quantile(dat$tmean, c(0.1, 0.75, 0.9), na.rm = TRUE),
                 Bound = range(dat$tmean,na.rm=T))
  bvar <- do.call(onebasis, c(list(x = seq(-15,30,0.1)), argvar))
  pred <- crosspred(bvar, coef = blup1[[i]]$blup, vcov = blup1[[i]]$vcov, model.link = 'log', cen = 25)
  mmt[i,1] = pred$predvar[which.min(pred$allRRfit)]
  mmt[i,1] = ifelse(mmt[i,1]<22, 22, mmt[i,1])
  mmt[i,1] = ifelse(mmt[i,1]>25, 25, mmt[i,1])
  pred <- crosspred(bvar, coef = blup2[[i]]$blup, vcov = blup2[[i]]$vcov, model.link = 'log', cen = 25)
  mmt[i,2] = pred$predvar[which.min(pred$allRRfit)]
  mmt[i,2] = ifelse(mmt[i,2]<22, 22, mmt[i,2])
  mmt[i,2] = ifelse(mmt[i,2]>25, 25, mmt[i,2])
  rm(dat,argvar,bvar,pred)
}
save(mmt, file = "D:/Projection/sample/mmt.RData")
