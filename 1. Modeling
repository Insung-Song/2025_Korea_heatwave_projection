rm(list = ls())

library(dlnm);library(splines);library(mixmeta)

# Loading Data
load("dlist.RData")
load('mp.RData')

sgg = names(dlist)
coef = matrix(NA, 25, 4)
vcov = lapply(1:25, function(x) matrix(NA, 4,4))

pb <- txtProgressBar(min = 0, max = length(sgg), style = 3) 
for(i in 1:25){
  setTxtProgressBar(pb, i)
  dat = dlist[[i]]
  argvar = list(fun = "ns",
                knots = quantile(dat$tmean, c(0.1, 0.75, 0.9), na.rm = TRUE),
                Bound = range(dat$tmean, na.rm = TRUE))
  arglag = list(fun = "ns", knots = logknots(21, nk = 3))
  cb = crossbasis(dat$tmean, argvar, arglag, lag = 21)
  
  m = glm(dth ~ cb + dow + ns(date, df = 7*length(unique(dat$year))),data = dat, family = quasipoisson)
  red = crossreduce(cb, m, cen = 10)
  coef[i,] = coef(red)
  vcov[[i]] = vcov(red)
  rm(dat, argvar, arglag, m, red, cb)
}

mx = mixmeta(coef~.,dat=mp,vcov,random=~1|sgg,na.action=na.exclude)
blup = blup(mx,vcov=T)
save(blup, file = "2nd_stage.RData")
rm(coef,vcov,mp,mx)

mmt = rep(NA,25)
names(mmt) = sgg
for(i in 1:25){
  setTxtProgressBar(pb, i)
  dat <- dlist[[i]]
  argvar <- list(fun = "ns",
                 knots = quantile(dat$tmean, c(0.1, 0.75, 0.9), na.rm = TRUE),
                 Bound = range(dat$tmean,na.rm=T))
  bvar <- do.call(onebasis, c(list(x = seq(-15,30,0.1)), argvar))
  pred <- crosspred(bvar, coef = blup[[i]]$blup, vcov = blup[[i]]$vcov, model.link = 'log', cen = 25)
  mmt[i] = pred$predvar[which.min(pred$allRRfit)]
  mmt[i]= ifelse(mmt[i]<22, 22, mmt[i])
  mmt[i] = ifelse(mmt[i]>25, 25, mmt[i])
  rm(dat,argvar,bvar,pred)
}
save(mmt, file = "mmt.RData")
